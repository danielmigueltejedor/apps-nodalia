#!/command/with-contenv bashio
# shellcheck shell=bash
set -euo pipefail

extract_action_from_text() {
  local text="${1:-}"
  case "${text}" in
    *action=enable*|*"\"action\":\"enable\""*) echo "enable" ;;
    *action=disable*|*"\"action\":\"disable\""*) echo "disable" ;;
    *action=audit*|*"\"action\":\"audit\""*) echo "audit" ;;
    *action=status*|*"\"action\":\"status\""*) echo "status" ;;
    *) echo "" ;;
  esac
}

action_qs="$(extract_action_from_text "${QUERY_STRING:-}")"

request_body=""
content_length_raw="${CONTENT_LENGTH:-0}"
action_body=""
if [[ "${REQUEST_METHOD:-GET}" == "POST" ]] && \
  [[ "${content_length_raw}" =~ ^[0-9]+$ ]] && \
  (( content_length_raw > 0 )) && \
  (( content_length_raw <= 8192 ));
then
  IFS= read -r -n "${content_length_raw}" request_body || true
  action_body="$(extract_action_from_text "${request_body}")"
fi

action_path=""
if [[ -n "${PATH_INFO:-}" ]]; then
  candidate="${PATH_INFO#/}"
  candidate="${candidate%%/*}"
  case "${candidate}" in
    enable|disable|audit|status) action_path="${candidate}" ;;
  esac
fi

if [[ -z "${action_path}" ]] && [[ -n "${REQUEST_URI:-}" ]]; then
  uri_path="${REQUEST_URI%%\?*}"
  case "${uri_path}" in
    */support/*)
      candidate="${uri_path##*/support/}"
      candidate="${candidate%%/*}"
      case "${candidate}" in
        enable|disable|audit|status) action_path="${candidate}" ;;
      esac
      ;;
  esac
fi

action_hdr=""
if [[ -n "${HTTP_X_NODALIA_ACTION:-}" ]]; then
  case "${HTTP_X_NODALIA_ACTION}" in
    enable|disable|audit|status) action_hdr="${HTTP_X_NODALIA_ACTION}" ;;
  esac
fi

action="${action_qs:-status}"
if [[ -n "${action_body}" ]]; then
  action="${action_body}"
fi
if [[ -n "${action_hdr}" ]]; then
  action="${action_hdr}"
fi
if [[ -n "${action_path}" ]]; then
  action="${action_path}"
fi

if [[ "${REQUEST_METHOD:-GET}" != "POST" ]] && [[ "${REQUEST_METHOD:-GET}" != "GET" ]]; then
  echo "Status: 405 Method Not Allowed"
  echo "Content-Type: application/json"
  echo
  echo '{"ok":false,"error":"method_not_allowed"}'
  exit 0
fi

set +e
payload="$(support-tunnel "${action}" 2>&1)"
rc=$?
set -e

content_type="application/json"
if [[ "${action}" == "audit" ]]; then
  content_type="text/plain; charset=utf-8"
fi

if (( rc == 0 )); then
  echo "Status: 200 OK"
else
  echo "Status: 400 Bad Request"
fi
echo "Content-Type: ${content_type}"
echo "Cache-Control: no-store"
echo
printf '%s\n' "${payload}"
