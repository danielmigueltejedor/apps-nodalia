#!/command/with-contenv bashio
# shellcheck shell=bash
set -euo pipefail

action="status"
case "${QUERY_STRING:-}" in
  *action=reconnect*) action="reconnect" ;;
  *action=logout*) action="logout" ;;
  *action=diag*) action="diag" ;;
  *action=status*) action="status" ;;
esac

if [[ "${REQUEST_METHOD:-GET}" != "POST" ]] && [[ "${action}" != "status" ]]; then
  echo "Status: 405 Method Not Allowed"
  echo "Content-Type: application/json"
  echo
  echo '{"ok":false,"error":"method_not_allowed"}'
  exit 0
fi

run_action() {
  local cmd_output rc
  case "${action}" in
    reconnect)
      set +e
      cmd_output="$(timeout 25 /opt/tailscale up 2>&1)"
      rc=$?
      set -e
      ;;
    logout)
      set +e
      cmd_output="$(timeout 20 /opt/tailscale logout 2>&1)"
      rc=$?
      set -e
      ;;
    diag)
      cmd_output=""
      rc=0
      ;;
    *)
      cmd_output=""
      rc=0
      ;;
  esac
  ACTION_OUTPUT="${cmd_output}"
  ACTION_RC="${rc}"
}

json_bool() {
  if [[ "${1:-false}" == "true" ]]; then
    echo "true"
  else
    echo "false"
  fi
}

run_action
status_json=$(/opt/tailscale status --json --self=true --peers=false 2>/dev/null || echo '{}')
backend_state="$(jq -r '.BackendState // "Unknown"' <<< "${status_json}" 2>/dev/null || echo "Unknown")"
auth_url="$(jq -r '.AuthURL // .Self.AuthURL // empty' <<< "${status_json}" 2>/dev/null || true)"
online="$(jq -r '.Self.Online // false' <<< "${status_json}" 2>/dev/null || echo "false")"
dns_name="$(jq -r '.Self.DNSName // empty' <<< "${status_json}" 2>/dev/null || true)"
tailnet="$(jq -r '.CurrentTailnet.Name // empty' <<< "${status_json}" 2>/dev/null || true)"
output_trimmed="$(printf '%s' "${ACTION_OUTPUT}" | tail -c 800)"

# Harden logout behavior: if state is still Running after logout attempt, retry with down+logout.
if [[ "${action}" == "logout" ]] && [[ "${backend_state}" == "Running" ]]; then
  set +e
  retry_output="$(
    {
      echo "[retry] tailscale down"
      /opt/tailscale down
      echo "[retry] tailscale logout"
      /opt/tailscale logout
    } 2>&1
  )"
  retry_rc=$?
  set -e
  ACTION_OUTPUT="${ACTION_OUTPUT}"$'\n'"${retry_output}"
  if (( ACTION_RC == 0 )) && (( retry_rc != 0 )); then
    ACTION_RC=${retry_rc}
  fi
  status_json=$(/opt/tailscale status --json --self=true --peers=false 2>/dev/null || echo '{}')
  backend_state="$(jq -r '.BackendState // "Unknown"' <<< "${status_json}" 2>/dev/null || echo "Unknown")"
  auth_url="$(jq -r '.AuthURL // .Self.AuthURL // empty' <<< "${status_json}" 2>/dev/null || true)"
  online="$(jq -r '.Self.Online // false' <<< "${status_json}" 2>/dev/null || echo "false")"
  dns_name="$(jq -r '.Self.DNSName // empty' <<< "${status_json}" 2>/dev/null || true)"
  tailnet="$(jq -r '.CurrentTailnet.Name // empty' <<< "${status_json}" 2>/dev/null || true)"
  output_trimmed="$(printf '%s' "${ACTION_OUTPUT}" | tail -c 800)"
fi

# Force logout path: if it still stays Running, clear local state and restart tailscaled.
if [[ "${action}" == "logout" ]] && [[ "${backend_state}" == "Running" ]]; then
  set +e
  force_output="$(
    {
      echo "[force] backend still Running, applying hard logout fallback"
      echo "[force] tailscale down"
      /opt/tailscale down
      daemon_pid="$(ps -eo pid,comm | awk '$2==\"tailscaled\"{print $1; exit}')"
      if [[ -n "${daemon_pid}" ]]; then
        echo "[force] stopping tailscaled pid=${daemon_pid}"
        kill "${daemon_pid}"
      else
        echo "[force] tailscaled pid not found"
      fi
      sleep 1
      echo "[force] removing local state files"
      rm -f /data/tailscaled.state
      rm -rf /data/state
      mkdir -p /data/state
      chmod 0700 /data/state
      echo "[force] waiting for s6 restart"
      sleep 2
      echo "[force] post-restart logout probe"
      timeout 15 /opt/tailscale logout || true
    } 2>&1
  )"
  force_rc=$?
  set -e
  ACTION_OUTPUT="${ACTION_OUTPUT}"$'\n'"${force_output}"
  if (( ACTION_RC == 0 )) && (( force_rc != 0 )); then
    ACTION_RC=${force_rc}
  fi
  status_json=$(/opt/tailscale status --json --self=true --peers=false 2>/dev/null || echo '{}')
  backend_state="$(jq -r '.BackendState // "Unknown"' <<< "${status_json}" 2>/dev/null || echo "Unknown")"
  auth_url="$(jq -r '.AuthURL // .Self.AuthURL // empty' <<< "${status_json}" 2>/dev/null || true)"
  online="$(jq -r '.Self.Online // false' <<< "${status_json}" 2>/dev/null || echo "false")"
  dns_name="$(jq -r '.Self.DNSName // empty' <<< "${status_json}" 2>/dev/null || true)"
  tailnet="$(jq -r '.CurrentTailnet.Name // empty' <<< "${status_json}" 2>/dev/null || true)"
  output_trimmed="$(printf '%s' "${ACTION_OUTPUT}" | tail -c 1200)"
fi
login_server="$(bashio::config "login_server" "https://controlplane.tailscale.com")"
socket_ok=false
webui_ok=false
control_ok=false
if [[ -S /var/run/tailscale/tailscaled.sock ]]; then
  socket_ok=true
fi
if curl -fsS --max-time 1 "http://127.0.0.1:25899/" > /dev/null 2>&1; then
  webui_ok=true
fi
if curl -fsS --max-time 2 "${login_server}" > /dev/null 2>&1; then
  control_ok=true
fi

health_score=0
if [[ "${backend_state}" == "Running" ]]; then
  health_score=$((health_score + 45))
elif [[ "${backend_state}" == "NeedsLogin" ]] || [[ "${backend_state}" == "NeedsMachineAuth" ]]; then
  health_score=$((health_score + 25))
fi
if [[ "${online}" == "true" ]]; then
  health_score=$((health_score + 20))
fi
if [[ "${webui_ok}" == "true" ]]; then
  health_score=$((health_score + 15))
fi
if [[ "${control_ok}" == "true" ]]; then
  health_score=$((health_score + 20))
fi
if (( health_score > 100 )); then
  health_score=100
fi

ok="true"
if (( ACTION_RC != 0 )); then
  # Reconnect can return non-zero while still resulting in login-required transitional states.
  if [[ "${action}" == "reconnect" ]] && { [[ "${backend_state}" == "NeedsLogin" ]] || [[ "${backend_state}" == "NeedsMachineAuth" ]] || [[ "${backend_state}" == "Running" ]]; }; then
    ok="true"
  else
    ok="false"
  fi
fi
if [[ "${action}" == "logout" ]] && [[ "${backend_state}" != "NeedsLogin" ]] && [[ "${backend_state}" != "NeedsMachineAuth" ]]; then
  ok="false"
fi

if [[ "${ok}" == "true" ]]; then
  echo "Status: 200 OK"
else
  echo "Status: 400 Bad Request"
fi
echo "Content-Type: application/json"
echo "Cache-Control: no-store"
echo

jq -nc \
  --arg action "${action}" \
  --arg backend_state "${backend_state}" \
  --arg auth_url "${auth_url}" \
  --arg online "${online}" \
  --arg dns_name "${dns_name}" \
  --arg tailnet "${tailnet}" \
  --arg login_server "${login_server}" \
  --arg socket_ok "${socket_ok}" \
  --arg webui_ok "${webui_ok}" \
  --arg control_ok "${control_ok}" \
  --arg output "${output_trimmed}" \
  --argjson health_score "${health_score}" \
  --argjson rc "${ACTION_RC}" \
  --argjson ok "$(json_bool "${ok}")" \
  '{
    ok: $ok,
    action: $action,
    rc: $rc,
    backend_state: $backend_state,
    auth_url: $auth_url,
    self_online: ($online == "true"),
    self_dns_name: $dns_name,
    tailnet: $tailnet,
    login_server: $login_server,
    health_score: $health_score,
    checks: {
      tailscaled_socket: ($socket_ok == "true"),
      webui_local: ($webui_ok == "true"),
      control_plane_reachable: ($control_ok == "true")
    },
    output: $output
  }'
