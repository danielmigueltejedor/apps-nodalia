#!/command/with-contenv bashio
# shellcheck shell=bash
set -euo pipefail

action="status"
case "${QUERY_STRING:-}" in
  *action=reconnect*) action="reconnect" ;;
  *action=logout*) action="logout" ;;
  *action=status*) action="status" ;;
esac

if [[ "${REQUEST_METHOD:-GET}" != "POST" ]] && [[ "${action}" != "status" ]]; then
  echo "Status: 405 Method Not Allowed"
  echo "Content-Type: application/json"
  echo
  echo '{"ok":false,"error":"method_not_allowed"}'
  exit 0
fi

run_action() {
  local cmd_output rc
  case "${action}" in
    reconnect)
      set +e
      cmd_output="$(timeout 25 /opt/tailscale up 2>&1)"
      rc=$?
      set -e
      ;;
    logout)
      set +e
      cmd_output="$(/opt/tailscale logout 2>&1)"
      rc=$?
      set -e
      ;;
    *)
      cmd_output=""
      rc=0
      ;;
  esac
  ACTION_OUTPUT="${cmd_output}"
  ACTION_RC="${rc}"
}

json_bool() {
  if [[ "${1:-false}" == "true" ]]; then
    echo "true"
  else
    echo "false"
  fi
}

run_action
status_json=$(/opt/tailscale status --json --self=true --peers=false 2>/dev/null || echo '{}')
backend_state="$(jq -r '.BackendState // "Unknown"' <<< "${status_json}" 2>/dev/null || echo "Unknown")"
auth_url="$(jq -r '.AuthURL // .Self.AuthURL // empty' <<< "${status_json}" 2>/dev/null || true)"
online="$(jq -r '.Self.Online // false' <<< "${status_json}" 2>/dev/null || echo "false")"
dns_name="$(jq -r '.Self.DNSName // empty' <<< "${status_json}" 2>/dev/null || true)"
tailnet="$(jq -r '.CurrentTailnet.Name // empty' <<< "${status_json}" 2>/dev/null || true)"
output_trimmed="$(printf '%s' "${ACTION_OUTPUT}" | tail -c 800)"

ok="true"
if (( ACTION_RC != 0 )); then
  # Reconnect can return non-zero while still resulting in login-required transitional states.
  if [[ "${action}" == "reconnect" ]] && { [[ "${backend_state}" == "NeedsLogin" ]] || [[ "${backend_state}" == "NeedsMachineAuth" ]] || [[ "${backend_state}" == "Running" ]]; }; then
    ok="true"
  else
    ok="false"
  fi
fi

if [[ "${ok}" == "true" ]]; then
  echo "Status: 200 OK"
else
  echo "Status: 400 Bad Request"
fi
echo "Content-Type: application/json"
echo "Cache-Control: no-store"
echo

jq -nc \
  --arg action "${action}" \
  --arg backend_state "${backend_state}" \
  --arg auth_url "${auth_url}" \
  --arg online "${online}" \
  --arg dns_name "${dns_name}" \
  --arg tailnet "${tailnet}" \
  --arg output "${output_trimmed}" \
  --argjson rc "${ACTION_RC}" \
  --argjson ok "$(json_bool "${ok}")" \
  '{
    ok: $ok,
    action: $action,
    rc: $rc,
    backend_state: $backend_state,
    auth_url: $auth_url,
    self_online: ($online == "true"),
    self_dns_name: $dns_name,
    tailnet: $tailnet,
    output: $output
  }'
