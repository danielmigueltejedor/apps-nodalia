#!/command/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Home Assistant Community Add-on: Tailscale
# Fetches files send via Taildrop
# ==============================================================================

# Ensure the directory exists
mkdir -p /share/taildrop

declare status_json
declare backend_state
declare get_output
declare get_rc

while true
do
  status_json=$(/opt/tailscale status --json --self=true --peers=false 2>/dev/null || true)
  backend_state=$(jq -r '.BackendState // "Unknown"' <<< "${status_json}" 2>/dev/null || echo "Unknown")

  if [[ "${backend_state}" != "Running" ]]; then
    sleep 15
    continue
  fi

  set +e
  get_output=$(/opt/tailscale file get --verbose "/share/taildrop" 2>&1)
  get_rc=$?
  set -e

  if (( get_rc == 0 )); then
    sleep 2
    continue
  fi

  if grep -q "Taildrop disabled; no storage directory" <<< "${get_output}"; then
    bashio::log.info "Taildrop storage not ready yet; retrying in 60s"
    sleep 60
    continue
  fi

  bashio::log.warning "Taildrop fetch failed; retrying in 10s: ${get_output}"
  sleep 10
done
