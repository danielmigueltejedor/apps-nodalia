#!/command/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Home Assistant Community Add-on: Tailscale
# Periodically writes runtime status for onboarding diagnostics
# ==============================================================================

readonly RUNTIME_STATE_FILE="/data/tailscale-runtime.json"
readonly POLL_INTERVAL=3
readonly LOG_HEARTBEAT_EVERY_LOOPS=20
readonly WEBUI_BANNER_RECOVERY_STREAK=20
readonly WEBUI_RECOVERY_COOLDOWN_SEC=120

declare status_json
declare backend_state
declare auth_url
declare self_online
declare self_dns_name
declare self_host_name
declare ipv4_list
declare ipv6_list
declare webui_ready
declare now
declare runtime_payload
declare setup_profile
declare webui_readonly
declare share_mode
declare webui_probe_s
declare webui_probe_body
declare webui_probe_payload
declare webui_probe_time
declare webui_http_code
declare direct_webui_url
declare support_json
declare support_enabled
declare support_tailnet_id
declare support_tailnet_match
declare support_eligible
declare support_active
declare support_url
declare support_reason
declare support_expires_at
declare support_ttl_minutes
declare dns_resolvers
declare dns_warning
declare dns_degraded
declare webui_reason
declare log_summary

declare -i ready_streak=0
declare -i start_epoch
declare -i now_epoch
declare -i uptime_sec
declare -i loop_count=0
declare -i banner_streak=0
declare -i last_web_recovery_epoch=0
declare prev_backend_state="__init__"
declare prev_webui_ready="__init__"
declare prev_webui_http_code="__init__"
declare prev_dns_degraded="__init__"
declare prev_dns_warning="__init__"
declare prev_support_eligible="__init__"
declare prev_support_active="__init__"

start_epoch=$(date +%s)

while true
do
  status_json=$(/opt/tailscale status --json --self=true --peers=false 2>/dev/null || echo '{}')
  backend_state=$(jq -r '.BackendState // "Unknown"' <<< "${status_json}" 2>/dev/null || echo "Unknown")
  auth_url=$(jq -r '.AuthURL // .Self.AuthURL // empty' <<< "${status_json}" 2>/dev/null || true)
  self_online=$(jq -r '.Self.Online // false' <<< "${status_json}" 2>/dev/null || echo "false")
  self_dns_name=$(jq -r '.Self.DNSName // empty' <<< "${status_json}" 2>/dev/null || true)
  self_host_name=$(jq -r '.Self.HostName // empty' <<< "${status_json}" 2>/dev/null || true)

  ipv4_list=$(/opt/tailscale ip -4 2>/dev/null | jq -Rsc 'split("\n") | map(select(length>0))' || echo '[]')
  ipv6_list=$(/opt/tailscale ip -6 2>/dev/null | jq -Rsc 'split("\n") | map(select(length>0))' || echo '[]')

  webui_ready=false
  webui_probe_s="n/a"
  webui_probe_body=""
  webui_http_code="000"
  webui_probe_payload="$(
    curl -sS --max-time 2 -w $'\n__TS_META__:%{time_total}:%{http_code}' "http://127.0.0.1:25899/" 2>/dev/null || true
  )"
  if [[ -n "${webui_probe_payload}" && "${webui_probe_payload}" == *"__TS_META__:"* ]]; then
    webui_probe_time="${webui_probe_payload##*__TS_META__:}"
    webui_http_code="${webui_probe_time##*:}"
    webui_probe_time="${webui_probe_time%:*}"
    webui_probe_body="${webui_probe_payload%$'\n'__TS_META__:*}"
    if [[ -n "${webui_probe_time}" ]]; then
      webui_probe_s="${webui_probe_time}"
    fi
    if [[ "${webui_http_code}" =~ ^(2[0-9][0-9]|3[0-9][0-9]|401|403)$ ]]; then
      if grep -qi "Tailscale web interface is unavailable" <<< "${webui_probe_body}"; then
        webui_ready=false
        ready_streak=0
      else
        webui_ready=true
        ready_streak=$((ready_streak + 1))
      fi
    else
      ready_streak=0
    fi
  else
    ready_streak=0
  fi
  webui_reason="ok"
  if [[ "${webui_http_code}" == "000" ]]; then
    webui_reason="probe-timeout"
  elif [[ ! "${webui_http_code}" =~ ^(2[0-9][0-9]|3[0-9][0-9]|401|403)$ ]]; then
    webui_reason="http-${webui_http_code}"
  elif grep -qi "Tailscale web interface is unavailable" <<< "${webui_probe_body}"; then
    webui_reason="upstream-unavailable-banner"
  fi

  setup_profile=$(bashio::config "setup_profile" "custom")
  if ! bashio::config.has_value "webui_readonly" || bashio::config.true "webui_readonly"; then
    webui_readonly=true
  else
    webui_readonly=false
  fi
  share_mode=$(bashio::config "share_homeassistant" "disabled")
  # In this add-on architecture, Web UI is served via ingress/web proxy.
  # Publishing a direct tailnet :5252 URL causes false expectations on many setups.
  direct_webui_url=""

  support_json="$(support-tunnel status 2>/dev/null || echo '{}')"
  support_enabled="$(jq -r '.support_enabled // false' <<< "${support_json}" 2>/dev/null || echo "false")"
  support_tailnet_id="$(jq -r '.support_target_id // empty' <<< "${support_json}" 2>/dev/null || true)"
  support_tailnet_match="$(jq -r '.tailnet_match // false' <<< "${support_json}" 2>/dev/null || echo "false")"
  support_eligible="$(jq -r '.eligible // false' <<< "${support_json}" 2>/dev/null || echo "false")"
  support_active="$(jq -r '.active // false' <<< "${support_json}" 2>/dev/null || echo "false")"
  support_url="$(jq -r '.url // empty' <<< "${support_json}" 2>/dev/null || true)"
  support_reason="$(jq -r '.reason // empty' <<< "${support_json}" 2>/dev/null || true)"
  support_expires_at="$(jq -r '.expires_at // empty' <<< "${support_json}" 2>/dev/null || true)"
  support_ttl_minutes="$(jq -r '.ttl_minutes // 0' <<< "${support_json}" 2>/dev/null || echo "0")"
  dns_resolvers="$(awk '/^[[:space:]]*nameserver[[:space:]]+/ {print $2}' /etc/resolv.conf 2>/dev/null | jq -Rsc 'split("\n") | map(select(length>0))' || echo '[]')"
  dns_warning="$(jq -r '
    (.Health // [])
    | map(select(type=="string"))
    | map(select(test("dns|nameserver|resolver"; "i")))
    | .[0] // empty
  ' <<< "${status_json}" 2>/dev/null || true)"
  if [[ -n "${dns_warning}" ]]; then
    dns_degraded=true
  else
    dns_degraded=false
  fi

  now_epoch=$(date +%s)
  uptime_sec=$((now_epoch - start_epoch))
  now="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
  runtime_payload=$(jq -nc \
    --arg updated_at "${now}" \
    --arg backend_state "${backend_state}" \
    --arg auth_url "${auth_url}" \
    --arg self_dns_name "${self_dns_name}" \
    --arg self_host_name "${self_host_name}" \
    --arg setup_profile "${setup_profile}" \
    --arg share_mode "${share_mode}" \
    --arg self_online "${self_online}" \
    --arg webui_ready "${webui_ready}" \
    --arg webui_readonly "${webui_readonly}" \
    --arg webui_probe_s "${webui_probe_s}" \
    --arg direct_webui_url "${direct_webui_url}" \
    --argjson webui_ready_streak "${ready_streak}" \
    --argjson uptime_sec "${uptime_sec}" \
    --arg support_enabled "${support_enabled}" \
    --arg support_tailnet_id "${support_tailnet_id}" \
    --arg support_tailnet_match "${support_tailnet_match}" \
    --arg support_eligible "${support_eligible}" \
    --arg support_active "${support_active}" \
    --arg support_url "${support_url}" \
    --arg support_reason "${support_reason}" \
    --arg support_expires_at "${support_expires_at}" \
    --arg support_ttl_minutes "${support_ttl_minutes}" \
    --arg dns_warning "${dns_warning}" \
    --arg dns_degraded "${dns_degraded}" \
    --arg dns_resolvers "${dns_resolvers}" \
    --arg ipv4 "${ipv4_list}" \
    --arg ipv6 "${ipv6_list}" \
    '{
      updated_at:$updated_at,
      backend_state:$backend_state,
      auth_url:$auth_url,
      self_online: ($self_online == "true"),
      webui_ready: ($webui_ready == "true"),
      webui_readonly: ($webui_readonly == "true"),
      webui_probe_s:$webui_probe_s,
      webui_ready_streak:$webui_ready_streak,
      uptime_sec:$uptime_sec,
      setup_profile:$setup_profile,
      share_mode:$share_mode,
      support_enabled: ($support_enabled == "true"),
      support_tailnet_id:$support_tailnet_id,
      support_tailnet_match: ($support_tailnet_match == "true"),
      support_eligible: ($support_eligible == "true"),
      support_active: ($support_active == "true"),
      support_url:$support_url,
      support_reason:$support_reason,
      support_expires_at:$support_expires_at,
      support_ttl_minutes:($support_ttl_minutes | tonumber? // 0),
      dns_warning:$dns_warning,
      dns_degraded:($dns_degraded == "true"),
      dns_resolvers: ($dns_resolvers | fromjson? // []),
      direct_webui_url:$direct_webui_url,
      self_dns_name:$self_dns_name,
      self_host_name:$self_host_name,
      ipv4: ($ipv4 | fromjson? // []),
      ipv6: ($ipv6 | fromjson? // [])
    }')

  printf '%s\n' "${runtime_payload}" > "${RUNTIME_STATE_FILE}"
  loop_count=$((loop_count + 1))

  if [[ "${backend_state}" == "Running" ]] && [[ "${webui_reason}" == "upstream-unavailable-banner" ]]; then
    banner_streak=$((banner_streak + 1))
  else
    banner_streak=0
  fi

  now_epoch=$(date +%s)
  if (( banner_streak >= WEBUI_BANNER_RECOVERY_STREAK )) && \
    (( now_epoch - last_web_recovery_epoch >= WEBUI_RECOVERY_COOLDOWN_SEC ));
  then
    bashio::log.warning \
      "runtime-status: webui unavailable banner persisted (${banner_streak} probes)." \
      "Restarting tailscale web process for recovery."
    if pkill -f '^/opt/tailscale .* web( |$)' > /dev/null 2>&1; then
      bashio::log.info "runtime-status: tailscale web process restart requested"
    else
      bashio::log.warning "runtime-status: unable to find tailscale web process to restart"
    fi
    last_web_recovery_epoch=${now_epoch}
    banner_streak=0
  fi

  if [[ "${backend_state}" != "${prev_backend_state}" ]] || \
    [[ "${webui_ready}" != "${prev_webui_ready}" ]] || \
    [[ "${webui_http_code}" != "${prev_webui_http_code}" ]] || \
    [[ "${dns_degraded}" != "${prev_dns_degraded}" ]] || \
    [[ "${dns_warning}" != "${prev_dns_warning}" ]] || \
    [[ "${support_eligible}" != "${prev_support_eligible}" ]] || \
    [[ "${support_active}" != "${prev_support_active}" ]] || \
    (( loop_count % LOG_HEARTBEAT_EVERY_LOOPS == 0 ));
  then
    log_summary="runtime-status: backend=${backend_state} online=${self_online} webui_ready=${webui_ready} streak=${ready_streak} webui_http=${webui_http_code} webui_reason=${webui_reason} probe_s=${webui_probe_s} dns_degraded=${dns_degraded} support_eligible=${support_eligible} support_active=${support_active}"
    bashio::log.info "${log_summary}"
    if [[ -n "${dns_warning}" ]]; then
      bashio::log.warning "runtime-status: dns_warning=${dns_warning}"
    fi
  fi

  prev_backend_state="${backend_state}"
  prev_webui_ready="${webui_ready}"
  prev_webui_http_code="${webui_http_code}"
  prev_dns_degraded="${dns_degraded}"
  prev_dns_warning="${dns_warning}"
  prev_support_eligible="${support_eligible}"
  prev_support_active="${support_active}"
  sleep "${POLL_INTERVAL}"
done
