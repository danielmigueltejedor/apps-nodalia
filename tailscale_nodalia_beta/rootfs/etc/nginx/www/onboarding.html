<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tailscale Onboarding</title>
  <style>
    :root {
      --bg: #eef3fb;
      --card: #ffffff;
      --text: #0f2138;
      --muted: #52637b;
      --accent: #0a63cf;
      --accent-2: #084996;
      --ok: #157347;
      --warn: #9a3412;
      --border: #d6e1ef;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", "Noto Sans", sans-serif;
      color: var(--text);
      background:
        radial-gradient(circle at 90% 0%, #d5e6ff 0%, rgba(213, 230, 255, 0) 45%),
        radial-gradient(circle at 0% 100%, #dfe9ff 0%, rgba(223, 233, 255, 0) 40%),
        var(--bg);
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 20px;
    }
    .card {
      width: min(760px, 100%);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(16, 33, 58, 0.08);
    }
    .hero {
      display: grid;
      gap: 8px;
      margin-bottom: 10px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      width: fit-content;
      font-size: 0.76rem;
      font-weight: 700;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      color: #084996;
      background: #e8f1ff;
      border: 1px solid #c9dcfb;
      border-radius: 999px;
      padding: 4px 10px;
    }
    h1 { margin: 0 0 10px; font-size: 1.4rem; }
    p { margin: 0 0 14px; color: var(--muted); }
    .state { font-weight: 700; margin-bottom: 12px; }
    .state.running { color: var(--ok); }
    .state.login { color: var(--warn); }
    .url-wrap {
      display: grid;
      gap: 10px;
      margin-top: 10px;
    }
    input[type="text"] {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 0.95rem;
    }
    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    button, a.btn {
      border: 0;
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 600;
      text-decoration: none;
      cursor: pointer;
      background: var(--accent);
      color: #fff;
    }
    button:hover, a.btn:hover { background: var(--accent-2); }
    .ghost {
      background: #e9eff7;
      color: #123;
    }
    .small { font-size: 0.86rem; color: var(--muted); margin-top: 12px; }
    .quick {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .advanced-only {
      display: block;
    }
    .advanced-hidden .advanced-only {
      display: none;
    }
    .panel {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      margin-top: 14px;
      background: #f8fbff;
    }
    .panel h2 {
      margin: 0 0 8px;
      font-size: 1rem;
    }
    .kv {
      display: grid;
      grid-template-columns: 180px 1fr;
      gap: 6px 10px;
      font-size: 0.9rem;
    }
    .kv code { word-break: break-all; }
    .diag-list {
      margin: 0;
      padding-left: 18px;
      color: var(--muted);
      font-size: 0.9rem;
    }
    .diag-ok { color: var(--ok); }
    .diag-ko { color: var(--warn); }
    .disabled {
      opacity: 0.55;
      pointer-events: none;
    }
    .steps {
      display: grid;
      gap: 8px;
      margin: 0 0 14px;
    }
    .step {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 0.9rem;
      color: var(--muted);
      background: #f7fafc;
    }
    .step.active {
      border-color: #7fb1f4;
      color: var(--text);
      background: #eef5ff;
      font-weight: 600;
    }
    .grid-2 {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }
    .profile {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      background: #fff;
    }
    .profile h3 {
      margin: 0 0 6px;
      font-size: 0.98rem;
    }
    .profile p {
      margin: 0 0 8px;
      font-size: 0.88rem;
    }
    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 0.84rem;
      background: #f3f7fb;
      border-radius: 8px;
      padding: 6px 8px;
      margin: 0 0 8px;
      overflow-wrap: anywhere;
    }
    .check {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
      color: var(--muted);
    }
    .check input {
      inline-size: 16px;
      block-size: 16px;
    }
    @media (max-width: 640px) {
      .card { padding: 14px; }
      .kv { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <main class="card">
    <section class="hero">
      <span class="badge">Nodalia Control Center</span>
      <h1>Asistente de inicio de sesion</h1>
      <p>Gestiona Tailscale desde aqui sin depender del iframe, con acceso directo cuando quieras.</p>
      <div class="quick">
        <a id="go-webui-btn" class="btn ghost" href="webui">Ir al iframe de Tailscale</a>
        <button id="hard-refresh-btn" type="button" class="ghost">Recargar panel</button>
        <button id="toggle-advanced-btn" type="button" class="ghost">Modo avanzado: ON</button>
      </div>
      <p class="small">Dentro del iframe veras un boton flotante para volver a este panel.</p>
    </section>
    <div class="steps">
      <div id="step-auth" class="step">Paso 1: Autenticacion en tu tailnet</div>
      <div id="step-warmup" class="step">Paso 2: Inicializacion de Web UI</div>
      <div id="step-access" class="step">Paso 3: Acceso operativo</div>
    </div>
    <div id="state" class="state">Cargando estado...</div>
    <div id="login-box" hidden>
      <div class="url-wrap">
        <input id="login-url" type="text" readonly value="">
        <div class="actions">
          <button id="copy-btn" type="button">Copiar URL</button>
          <a id="open-btn" class="btn" href="#" target="_blank" rel="noopener noreferrer">Abrir URL</a>
          <button id="refresh-btn" type="button" class="ghost">Actualizar estado</button>
        </div>
      </div>
    </div>
    <div id="ok-box" hidden>
      <div class="actions">
        <a id="open-webui-btn" class="btn disabled" href="webui">Entrar Web UI (ingress)</a>
        <a id="open-direct-btn" class="btn ghost disabled" href="#" target="_blank" rel="noopener noreferrer">Abrir Web UI directa (tailnet)</a>
        <button id="refresh-ok-btn" type="button" class="ghost">Actualizar estado</button>
        <button id="cancel-redirect-btn" type="button" class="ghost" hidden>Cancelar auto-entrada</button>
      </div>
      <label class="check" style="margin-top:10px;">
        <input id="auto-open-check" type="checkbox" checked>
        Abrir Web UI automaticamente cuando este lista
      </label>
      <p id="redirect-state" class="small"></p>
    </div>
    <section class="panel">
      <h2>Estado en vivo</h2>
      <div class="kv">
        <div>Backend:</div><div><code id="rt-backend">-</code></div>
        <div>Web UI lista:</div><div><code id="rt-webui">-</code></div>
        <div>Web UI streak:</div><div><code id="rt-webui-streak">-</code></div>
        <div>Web UI probe(s):</div><div><code id="rt-webui-probe">-</code></div>
        <div>Web UI readonly:</div><div><code id="rt-readonly">-</code></div>
        <div>Self online:</div><div><code id="rt-online">-</code></div>
        <div>Perfil:</div><div><code id="rt-profile">-</code></div>
        <div>Share mode:</div><div><code id="rt-share">-</code></div>
        <div>DNSName:</div><div><code id="rt-dnsname">-</code></div>
        <div>HostName:</div><div><code id="rt-hostname">-</code></div>
        <div>IPv4:</div><div><code id="rt-ipv4">-</code></div>
        <div>IPv6:</div><div><code id="rt-ipv6">-</code></div>
        <div>Uptime(s):</div><div><code id="rt-uptime">-</code></div>
        <div>Actualizado:</div><div><code id="rt-updated">-</code></div>
      </div>
      <div class="actions" style="margin-top:10px;">
        <button id="diag-btn" type="button" class="ghost">Ejecutar diagnóstico</button>
        <button id="copy-report-btn" type="button" class="ghost">Copiar reporte</button>
      </div>
      <ul id="diag-list" class="diag-list"></ul>
    </section>
    <section class="panel">
      <h2>Control rapido</h2>
      <p class="small">Acciones operativas sin salir del panel principal.</p>
      <div class="actions">
        <button id="op-reconnect-btn" type="button">Reintentar conexion</button>
        <button id="op-logout-btn" type="button" class="ghost">Cerrar sesion</button>
        <button id="op-refresh-btn" type="button" class="ghost">Actualizar estado ahora</button>
      </div>
      <p id="op-message" class="small"></p>
      <div id="op-output" class="mono" hidden></div>
    </section>
    <section class="panel advanced-only">
      <h2>Sugerencias inteligentes</h2>
      <ul id="suggestions-list" class="diag-list"></ul>
      <div class="actions" style="margin-top:10px;">
        <button id="copy-acl-webui-btn" type="button" class="ghost">Copiar ACL Web UI (self:5252)</button>
        <button id="copy-tagowners-btn" type="button" class="ghost">Copiar bloque tagOwners</button>
      </div>
    </section>
    <section class="panel advanced-only">
      <h2>Soporte remoto</h2>
      <p class="small">Disponible solo si esta app esta en la tailnet de soporte configurada.</p>
      <div class="kv">
        <div>Soporte habilitado:</div><div><code id="sup-enabled">-</code></div>
        <div>Tailnet objetivo:</div><div><code id="sup-tailnet">-</code></div>
        <div>Tailnet coincide:</div><div><code id="sup-match">-</code></div>
        <div>Elegible:</div><div><code id="sup-eligible">-</code></div>
        <div>Tunel activo:</div><div><code id="sup-active">-</code></div>
        <div>URL temporal:</div><div><code id="sup-url">-</code></div>
        <div>Motivo:</div><div><code id="sup-reason">-</code></div>
      </div>
      <div class="actions" style="margin-top:10px;">
        <button id="sup-enable-btn" type="button" class="ghost">Activar tunel soporte</button>
        <button id="sup-disable-btn" type="button" class="ghost">Desactivar tunel soporte</button>
        <button id="sup-copy-url-btn" type="button" class="ghost">Copiar URL soporte</button>
      </div>
      <p id="sup-message" class="small"></p>
    </section>
    <section class="panel advanced-only">
      <h2>Perfiles recomendados</h2>
      <div class="grid-2">
        <article class="profile">
          <h3>Acceso remoto basico</h3>
          <p>Recomendado para entrar a Home Assistant desde fuera de casa.</p>
          <div class="mono">setup_profile: home_access</div>
          <button id="copy-profile-home" type="button" class="ghost">Copiar</button>
        </article>
        <article class="profile">
          <h3>Router de subred</h3>
          <p>Publica redes LAN para acceder desde tu tailnet.</p>
          <div class="mono">setup_profile: subnet_router</div>
          <button id="copy-profile-subnet" type="button" class="ghost">Copiar</button>
        </article>
      </div>
    </section>
    <section class="panel advanced-only">
      <h2>Control de sesion</h2>
      <p class="small">Si ves "Viewing" en Web UI, usa acceso directo tailnet y revisa ACL/tagOwners.</p>
      <div class="mono" id="session-report">tailscale status --json | jq '.BackendState,.AuthURL'</div>
      <button id="copy-session-report" type="button" class="ghost">Copiar comando de diagnostico</button>
    </section>
    <p class="small">Nota: esta pagina lee <code>onboarding.json</code> y <code>runtime.json</code> generados por la aplicacion.</p>
  </main>
  <script>
    const stateEl = document.getElementById("state");
    const loginBox = document.getElementById("login-box");
    const okBox = document.getElementById("ok-box");
    const loginUrlInput = document.getElementById("login-url");
    const copyBtn = document.getElementById("copy-btn");
    const openBtn = document.getElementById("open-btn");
    const openWebuiBtn = document.getElementById("open-webui-btn");
    const openDirectBtn = document.getElementById("open-direct-btn");
    const goWebuiBtn = document.getElementById("go-webui-btn");
    const hardRefreshBtn = document.getElementById("hard-refresh-btn");
    const toggleAdvancedBtn = document.getElementById("toggle-advanced-btn");
    const refreshBtn = document.getElementById("refresh-btn");
    const refreshOkBtn = document.getElementById("refresh-ok-btn");
    const cancelRedirectBtn = document.getElementById("cancel-redirect-btn");
    const autoOpenCheck = document.getElementById("auto-open-check");
    const redirectState = document.getElementById("redirect-state");
    const diagBtn = document.getElementById("diag-btn");
    const copyReportBtn = document.getElementById("copy-report-btn");
    const diagList = document.getElementById("diag-list");
    const suggestionsList = document.getElementById("suggestions-list");
    const copyAclWebuiBtn = document.getElementById("copy-acl-webui-btn");
    const copyTagOwnersBtn = document.getElementById("copy-tagowners-btn");
    const supportEnabled = document.getElementById("sup-enabled");
    const supportTailnet = document.getElementById("sup-tailnet");
    const supportMatch = document.getElementById("sup-match");
    const supportEligible = document.getElementById("sup-eligible");
    const supportActive = document.getElementById("sup-active");
    const supportUrl = document.getElementById("sup-url");
    const supportReason = document.getElementById("sup-reason");
    const supportMessage = document.getElementById("sup-message");
    const supportEnableBtn = document.getElementById("sup-enable-btn");
    const supportDisableBtn = document.getElementById("sup-disable-btn");
    const supportCopyUrlBtn = document.getElementById("sup-copy-url-btn");
    const rtBackend = document.getElementById("rt-backend");
    const rtWebUi = document.getElementById("rt-webui");
    const rtWebUiStreak = document.getElementById("rt-webui-streak");
    const rtWebUiProbe = document.getElementById("rt-webui-probe");
    const rtReadonly = document.getElementById("rt-readonly");
    const rtOnline = document.getElementById("rt-online");
    const rtProfile = document.getElementById("rt-profile");
    const rtShare = document.getElementById("rt-share");
    const rtDnsName = document.getElementById("rt-dnsname");
    const rtHostName = document.getElementById("rt-hostname");
    const rtIpv4 = document.getElementById("rt-ipv4");
    const rtIpv6 = document.getElementById("rt-ipv6");
    const rtUptime = document.getElementById("rt-uptime");
    const rtUpdated = document.getElementById("rt-updated");
    const stepAuth = document.getElementById("step-auth");
    const stepWarmup = document.getElementById("step-warmup");
    const stepAccess = document.getElementById("step-access");
    const copyProfileHome = document.getElementById("copy-profile-home");
    const copyProfileSubnet = document.getElementById("copy-profile-subnet");
    const copySessionReport = document.getElementById("copy-session-report");
    const opReconnectBtn = document.getElementById("op-reconnect-btn");
    const opLogoutBtn = document.getElementById("op-logout-btn");
    const opRefreshBtn = document.getElementById("op-refresh-btn");
    const opMessage = document.getElementById("op-message");
    const opOutput = document.getElementById("op-output");
    let pollHandle = null;
    let redirectHandle = null;
    let lastOnboarding = null;
    let lastRuntime = null;
    let lastSupportUrl = "";
    let lastStateMessage = "";
    let lastStateClass = "";
    let isFirstRender = true;
    let advancedModeEnabled = true;
    const RUNTIME_CACHE_KEY = "nodalia_runtime_cache_v1";
    const UI_PREFS_KEY = "nodalia_ui_prefs_v1";
    const aclWebUiSnippet = JSON.stringify({
      acls: [
        { action: "accept", src: ["autogroup:member"], dst: ["autogroup:self:5252"] }
      ]
    }, null, 2);
    const tagOwnersSnippet = JSON.stringify({
      tagOwners: {
        "tag:ha": ["autogroup:admin"]
      }
    }, null, 2);

    async function copyText(text, targetButton, okLabel, defaultLabel) {
      try {
        await navigator.clipboard.writeText(text);
        if (targetButton) {
          targetButton.textContent = okLabel;
          setTimeout(() => { targetButton.textContent = defaultLabel; }, 1200);
        }
      } catch (_) {
        window.prompt("Copia este texto:", text);
      }
    }

    async function fetchJsonWithTimeout(path, timeoutMs = 1200) {
      const controller = new AbortController();
      const timeoutHandle = setTimeout(() => controller.abort(), timeoutMs);
      try {
        const response = await fetch(path, { cache: "no-store", signal: controller.signal });
        if (!response.ok) {
          throw new Error("http_" + response.status);
        }
        return await response.json();
      } finally {
        clearTimeout(timeoutHandle);
      }
    }

    function loadUiPrefs() {
      try {
        const raw = localStorage.getItem(UI_PREFS_KEY);
        if (!raw) {
          return;
        }
        const prefs = JSON.parse(raw);
        advancedModeEnabled = prefs?.advanced_mode !== false;
      } catch (_) {
      }
    }

    function saveUiPrefs() {
      try {
        localStorage.setItem(UI_PREFS_KEY, JSON.stringify({ advanced_mode: advancedModeEnabled }));
      } catch (_) {
      }
    }

    function renderAdvancedMode() {
      document.body.classList.toggle("advanced-hidden", !advancedModeEnabled);
      toggleAdvancedBtn.textContent = advancedModeEnabled ? "Modo avanzado: ON" : "Modo avanzado: OFF";
    }

    function setSupportButtonState(busy) {
      supportEnableBtn.disabled = busy;
      supportDisableBtn.disabled = busy;
      supportCopyUrlBtn.disabled = busy;
    }

    function renderSupportFromRuntime(runtime) {
      const enabled = Boolean(runtime?.support_enabled);
      const match = Boolean(runtime?.support_tailnet_match);
      const eligible = Boolean(runtime?.support_eligible);
      const active = Boolean(runtime?.support_active);
      const url = String(runtime?.support_url || "");
      const reason = String(runtime?.support_reason || "");
      supportEnabled.textContent = enabled ? "true" : "false";
      supportTailnet.textContent = String(runtime?.support_tailnet_id || "-");
      supportMatch.textContent = match ? "true" : "false";
      supportEligible.textContent = eligible ? "true" : "false";
      supportActive.textContent = active ? "true" : "false";
      supportUrl.textContent = url || "-";
      supportReason.textContent = reason || "-";
      lastSupportUrl = url;
      supportEnableBtn.classList.toggle("disabled", !enabled || !eligible);
      supportDisableBtn.classList.toggle("disabled", !active);
      supportCopyUrlBtn.classList.toggle("disabled", !url);
    }

    function applyRuntimeData(data) {
      lastRuntime = data;
      rtBackend.textContent = String(data.backend_state || "-");
      rtWebUi.textContent = data.webui_ready ? "true" : "false";
      rtWebUiStreak.textContent = Number(data.webui_ready_streak || 0).toString();
      rtWebUiProbe.textContent = String(data.webui_probe_s || "-");
      rtReadonly.textContent = data.webui_readonly ? "true" : "false";
      rtOnline.textContent = data.self_online ? "true" : "false";
      rtProfile.textContent = String(data.setup_profile || "-");
      rtShare.textContent = String(data.share_mode || "-");
      rtDnsName.textContent = String(data.self_dns_name || "-");
      rtHostName.textContent = String(data.self_host_name || "-");
      rtIpv4.textContent = Array.isArray(data.ipv4) && data.ipv4.length ? data.ipv4.join(", ") : "-";
      rtIpv6.textContent = Array.isArray(data.ipv6) && data.ipv6.length ? data.ipv6.join(", ") : "-";
      rtUptime.textContent = Number(data.uptime_sec || 0).toString();
      rtUpdated.textContent = String(data.updated_at || "-");
      renderSupportFromRuntime(data);
      if (typeof data.direct_webui_url === "string" && data.direct_webui_url.length > 0) {
        openDirectBtn.href = data.direct_webui_url;
        openDirectBtn.classList.remove("disabled");
      } else {
        openDirectBtn.classList.add("disabled");
      }
      try {
        localStorage.setItem(RUNTIME_CACHE_KEY, JSON.stringify(data));
      } catch (_) {
      }
    }

    function hydrateRuntimeFromCache() {
      try {
        const raw = localStorage.getItem(RUNTIME_CACHE_KEY);
        if (!raw) {
          return;
        }
        const data = JSON.parse(raw);
        if (data && typeof data === "object") {
          applyRuntimeData(data);
        }
      } catch (_) {
      }
    }

    async function callSupportApi(action, method = "GET") {
      const response = await fetch("support-api?action=" + encodeURIComponent(action) + "&_ts=" + Date.now(), {
        method,
        cache: "no-store",
      });
      const payload = await response.text();
      let data;
      try {
        data = JSON.parse(payload);
      } catch (_) {
        data = { ok: false, raw: payload };
      }
      if (!response.ok) {
        throw new Error(data?.error || "support_api_failed");
      }
      return data;
    }

    async function callControlApi(action, method = "POST") {
      const response = await fetch("control-api?action=" + encodeURIComponent(action) + "&_ts=" + Date.now(), {
        method,
        cache: "no-store",
      });
      const payload = await response.text();
      let data;
      try {
        data = JSON.parse(payload);
      } catch (_) {
        data = { ok: false, raw: payload };
      }
      if (!response.ok) {
        throw new Error(data?.output || data?.error || "control_api_failed");
      }
      return data;
    }

    function schedulePoll(delayMs = 1000) {
      if (pollHandle) {
        clearTimeout(pollHandle);
      }
      if (document.visibilityState === "hidden") {
        delayMs = Math.max(delayMs, 3000);
      }
      pollHandle = setTimeout(loadState, delayMs);
    }

    function updateStateView(message, cssClass) {
      if (lastStateMessage !== message) {
        stateEl.textContent = message;
        lastStateMessage = message;
      }
      if (lastStateClass !== cssClass) {
        stateEl.className = "state" + (cssClass ? " " + cssClass : "");
        lastStateClass = cssClass;
      }
    }

    function setOpButtonsBusy(busy) {
      opReconnectBtn.disabled = busy;
      opLogoutBtn.disabled = busy;
      opRefreshBtn.disabled = busy;
    }

    function cancelAutoRedirect() {
      if (redirectHandle) {
        clearTimeout(redirectHandle);
        redirectHandle = null;
      }
      cancelRedirectBtn.hidden = true;
      redirectState.textContent = "";
    }

    function startAutoRedirect() {
      cancelAutoRedirect();
      if (!autoOpenCheck.checked || openWebuiBtn.classList.contains("disabled")) {
        return;
      }
      let countdown = 3;
      cancelRedirectBtn.hidden = false;
      redirectState.textContent = "Redireccion automatica en " + countdown + "s...";
      const tick = () => {
        if (openWebuiBtn.classList.contains("disabled")) {
          cancelAutoRedirect();
          return;
        }
        countdown -= 1;
        if (countdown <= 0) {
          window.location.replace("webui");
          return;
        }
        redirectState.textContent = "Redireccion automatica en " + countdown + "s...";
        redirectHandle = setTimeout(tick, 1000);
      };
      redirectHandle = setTimeout(tick, 1000);
    }

    function setActiveStep(step) {
      stepAuth.classList.remove("active");
      stepWarmup.classList.remove("active");
      stepAccess.classList.remove("active");
      if (step === "auth") stepAuth.classList.add("active");
      if (step === "warmup") stepWarmup.classList.add("active");
      if (step === "access") stepAccess.classList.add("active");
    }

    function renderSuggestions() {
      const suggestions = [];
      const backend = String(lastRuntime?.backend_state || lastOnboarding?.backend_state || "Unknown");
      const needsLogin = Boolean(lastOnboarding?.needs_login);
      const isReadonly = Boolean(lastRuntime?.webui_readonly);
      const hasTailnetIp = Array.isArray(lastRuntime?.ipv4) && lastRuntime.ipv4.length > 0;
      const streak = Number(lastRuntime?.webui_ready_streak || 0);

      if (needsLogin) {
        suggestions.push("Login pendiente: abre la URL de inicio y completa la autenticacion.");
      }
      if (backend === "NeedsMachineAuth") {
        suggestions.push("Nodo pendiente de aprobacion en la consola de admin de Tailscale (MachineAuth).");
      }
      if (backend !== "Running") {
        suggestions.push("Backend aun no esta Running: espera 20-60s tras actualizar/reinstalar.");
      }
      if (backend === "Running" && streak < 2) {
        suggestions.push("Web UI calentando: manten esta pagina abierta y pulsa Actualizar estado.");
      }
      if (isReadonly) {
        suggestions.push("Modo readonly activo: para logout/cambios avanzados pon webui_readonly=false.");
      }
      if (!isReadonly && hasTailnetIp) {
        suggestions.push("Si ves 'Viewing', revisa ACL y usa acceso directo por tailnet para control total.");
      }
      if (!hasTailnetIp) {
        suggestions.push("Sin IP tailnet detectada: revisa conectividad y estado de inicio de sesion.");
      }
      if (lastRuntime?.support_enabled && !lastRuntime?.support_tailnet_match) {
        suggestions.push("Soporte remoto bloqueado: esta instancia no coincide con la tailnet de soporte.");
      }
      if (!lastRuntime?.support_enabled) {
        suggestions.push("Soporte remoto desactivado en configuracion: activa support_tunnel_enabled si lo necesitas.");
      }
      if (suggestions.length === 0) {
        suggestions.push("Estado estable: sin acciones pendientes.");
      }

      suggestionsList.innerHTML = suggestions.map((item) => `<li>${item}</li>`).join("");
    }

    async function loadState() {
      let nextDelayMs = 1200;
      if (isFirstRender) {
        updateStateView("Cargando estado...", "");
      }
      cancelAutoRedirect();
      try {
        const ts = Date.now();
        const onboardingPromise = fetchJsonWithTimeout("onboarding.json?_ts=" + ts, 1500);
        const runtimePromise = refreshRuntime(900);
        const data = await onboardingPromise;
        lastOnboarding = data;
        await runtimePromise;
        const runtimeBackendState = String(lastRuntime?.backend_state || "");
        const onboardingBackendState = String(data.backend_state || "Unknown");
        const backendState = runtimeBackendState || onboardingBackendState;
        const runtimeNeedsLogin = runtimeBackendState === "NeedsLogin" || runtimeBackendState === "NeedsMachineAuth";
        const needsLogin = runtimeBackendState ? runtimeNeedsLogin : Boolean(data.needs_login);
        const authUrl = String(lastRuntime?.auth_url || data.auth_url || "");

        if (needsLogin) {
          setActiveStep("auth");
          openWebuiBtn.classList.add("disabled");
          openDirectBtn.classList.add("disabled");
          updateStateView("Estado: login requerido (" + backendState + ")", "login");
          if (authUrl) {
            loginUrlInput.value = authUrl;
            openBtn.href = authUrl;
            loginBox.hidden = false;
            okBox.hidden = true;
          } else {
            okBox.hidden = false;
            loginBox.hidden = true;
          }
          renderSuggestions();
          nextDelayMs = 1500;
          isFirstRender = false;
          return;
        }

        if (backendState !== "Running") {
          setActiveStep("warmup");
          openWebuiBtn.classList.add("disabled");
          updateStateView("Estado: iniciando (" + backendState + ")", "login");
          okBox.hidden = false;
          loginBox.hidden = true;
          renderSuggestions();
          nextDelayMs = 900;
          isFirstRender = false;
          return;
        }

        updateStateView("Estado: conectado (" + backendState + "). Verificando Web UI...", "running");
        okBox.hidden = false;
        loginBox.hidden = true;
        const webUiReady = Boolean(lastRuntime?.webui_ready);
        const streak = Number(lastRuntime?.webui_ready_streak || 0);
        if (webUiReady && streak >= 2) {
          setActiveStep("access");
          updateStateView("Estado: conectado (" + backendState + "). Web UI lista.", "running");
          openWebuiBtn.classList.remove("disabled");
          startAutoRedirect();
        } else {
          setActiveStep("warmup");
          openWebuiBtn.classList.add("disabled");
          if (webUiReady) {
            updateStateView("Estado: conectado (" + backendState + "). Confirmando disponibilidad de Web UI...", "running");
          } else {
            updateStateView("Estado: conectado (" + backendState + "), la Web UI aun no responde. Reintentando...", "running");
          }
          nextDelayMs = 600;
        }
        renderSuggestions();
        isFirstRender = false;
        return;
      } catch (error) {
        updateStateView("Estado no disponible. La aplicacion puede seguir arrancando.", "login");
        okBox.hidden = false;
        loginBox.hidden = true;
        renderSuggestions();
        nextDelayMs = 1800;
      } finally {
        schedulePoll(nextDelayMs);
      }
    }

    async function refreshRuntime(timeoutMs = 1200) {
      try {
        const data = await fetchJsonWithTimeout("runtime.json?_ts=" + Date.now(), timeoutMs);
        applyRuntimeData(data);
        return data;
      } catch (_) {
        rtBackend.textContent = "n/a";
        rtWebUi.textContent = "n/a";
        rtWebUiStreak.textContent = "n/a";
        rtWebUiProbe.textContent = "n/a";
        rtOnline.textContent = "n/a";
        rtUptime.textContent = "n/a";
        rtUpdated.textContent = "n/a";
        supportEnabled.textContent = "n/a";
        supportTailnet.textContent = "n/a";
        supportMatch.textContent = "n/a";
        supportEligible.textContent = "n/a";
        supportActive.textContent = "n/a";
        supportUrl.textContent = "n/a";
        supportReason.textContent = "runtime unavailable";
        supportEnableBtn.classList.add("disabled");
        supportDisableBtn.classList.add("disabled");
        supportCopyUrlBtn.classList.add("disabled");
        return null;
      }
    }

    async function runDiagnostics() {
      const checks = [];
      checks.push({ label: "onboarding.json disponible", ok: !!lastOnboarding });
      checks.push({ label: "runtime.json disponible", ok: !!lastRuntime });
      checks.push({ label: "backend Running", ok: (lastRuntime?.backend_state || lastOnboarding?.backend_state) === "Running" });
      checks.push({ label: "webui_ready=true", ok: !!lastRuntime?.webui_ready });
      checks.push({ label: "webui_ready_streak>=2", ok: Number(lastRuntime?.webui_ready_streak || 0) >= 2 });
      checks.push({ label: "self_online=true", ok: !!lastRuntime?.self_online });
      checks.push({ label: "support elegible", ok: !!lastRuntime?.support_eligible });

      diagList.innerHTML = checks.map((c) =>
        `<li class="${c.ok ? "diag-ok" : "diag-ko"}">${c.ok ? "OK" : "WARN"}: ${c.label}</li>`
      ).join("");
    }

    async function copyReport() {
      const report = {
        generated_at: new Date().toISOString(),
        onboarding: lastOnboarding,
        runtime: lastRuntime,
      };
      const text = JSON.stringify(report, null, 2);
      try {
        await navigator.clipboard.writeText(text);
        copyReportBtn.textContent = "Reporte copiado";
        setTimeout(() => { copyReportBtn.textContent = "Copiar reporte"; }, 1200);
      } catch (_) {
        alert("No se pudo copiar automáticamente. Abre la consola para copiar el reporte.");
        console.log("Tailscale onboarding report:", text);
      }
    }

    copyBtn.addEventListener("click", async () => {
      await copyText(loginUrlInput.value, copyBtn, "Copiado", "Copiar URL");
    });
    copyProfileHome.addEventListener("click", async () => {
      await copyText("setup_profile: home_access", copyProfileHome, "Copiado", "Copiar");
    });
    copyProfileSubnet.addEventListener("click", async () => {
      await copyText("setup_profile: subnet_router", copyProfileSubnet, "Copiado", "Copiar");
    });
    copySessionReport.addEventListener("click", async () => {
      const cmd = "tailscale status --json | jq '.BackendState,.AuthURL'";
      await copyText(cmd, copySessionReport, "Comando copiado", "Copiar comando de diagnostico");
    });
    copyAclWebuiBtn.addEventListener("click", async () => {
      await copyText(aclWebUiSnippet, copyAclWebuiBtn, "ACL copiada", "Copiar ACL Web UI (self:5252)");
    });
    copyTagOwnersBtn.addEventListener("click", async () => {
      await copyText(tagOwnersSnippet, copyTagOwnersBtn, "tagOwners copiado", "Copiar bloque tagOwners");
    });
    supportEnableBtn.addEventListener("click", async () => {
      if (supportEnableBtn.classList.contains("disabled")) {
        return;
      }
      setSupportButtonState(true);
      supportMessage.textContent = "Activando tunel de soporte...";
      try {
        const data = await callSupportApi("enable", "POST");
        renderSupportFromRuntime(data);
        supportMessage.textContent = data.url
          ? "Tunel activo. URL temporal lista."
          : "Tunel activado, esperando URL temporal...";
      } catch (error) {
        supportMessage.textContent = "No se pudo activar el tunel: " + error.message;
      } finally {
        setSupportButtonState(false);
      }
    });
    supportDisableBtn.addEventListener("click", async () => {
      if (supportDisableBtn.classList.contains("disabled")) {
        return;
      }
      setSupportButtonState(true);
      supportMessage.textContent = "Desactivando tunel de soporte...";
      try {
        const data = await callSupportApi("disable", "POST");
        renderSupportFromRuntime(data);
        supportMessage.textContent = "Tunel de soporte desactivado.";
      } catch (error) {
        supportMessage.textContent = "No se pudo desactivar el tunel: " + error.message;
      } finally {
        setSupportButtonState(false);
      }
    });
    supportCopyUrlBtn.addEventListener("click", async () => {
      if (supportCopyUrlBtn.classList.contains("disabled") || !lastSupportUrl) {
        return;
      }
      await copyText(lastSupportUrl, supportCopyUrlBtn, "URL copiada", "Copiar URL soporte");
    });
    opReconnectBtn.addEventListener("click", async () => {
      setOpButtonsBusy(true);
      opMessage.textContent = "Reintentando conexion con Tailscale...";
      opOutput.hidden = true;
      try {
        const data = await callControlApi("reconnect", "POST");
        opMessage.textContent = data.ok
          ? "Accion completada. Estado: " + String(data.backend_state || "Unknown")
          : "No se pudo completar reconnect.";
        if (data.output) {
          opOutput.textContent = data.output;
          opOutput.hidden = false;
        }
      } catch (error) {
        opMessage.textContent = "Error al reconectar: " + error.message;
      } finally {
        await refreshRuntime(1800);
        loadState();
        setOpButtonsBusy(false);
      }
    });
    opLogoutBtn.addEventListener("click", async () => {
      const confirmed = window.confirm("Se cerrara la sesion actual de Tailscale en este dispositivo. Continuar?");
      if (!confirmed) {
        return;
      }
      setOpButtonsBusy(true);
      opMessage.textContent = "Cerrando sesion...";
      opOutput.hidden = true;
      try {
        const data = await callControlApi("logout", "POST");
        opMessage.textContent = data.ok
          ? "Sesion cerrada. Vuelve a autenticar desde esta pagina."
          : "No se pudo cerrar sesion.";
        if (data.output) {
          opOutput.textContent = data.output;
          opOutput.hidden = false;
        }
      } catch (error) {
        opMessage.textContent = "Error al cerrar sesion: " + error.message;
      } finally {
        await refreshRuntime(1800);
        loadState();
        setOpButtonsBusy(false);
      }
    });
    opRefreshBtn.addEventListener("click", async () => {
      opMessage.textContent = "Actualizando estado...";
      await refreshRuntime(1800);
      loadState();
      opMessage.textContent = "Estado actualizado.";
    });

    refreshBtn.addEventListener("click", () => {
      if (pollHandle) {
        clearTimeout(pollHandle);
      }
      cancelAutoRedirect();
      loadState();
    });
    refreshOkBtn.addEventListener("click", () => {
      if (pollHandle) {
        clearTimeout(pollHandle);
      }
      cancelAutoRedirect();
      loadState();
    });
    cancelRedirectBtn.addEventListener("click", cancelAutoRedirect);
    autoOpenCheck.addEventListener("change", () => {
      if (!autoOpenCheck.checked) {
        cancelAutoRedirect();
      } else if (!openWebuiBtn.classList.contains("disabled")) {
        startAutoRedirect();
      }
    });
    openWebuiBtn.addEventListener("click", (event) => {
      if (openWebuiBtn.classList.contains("disabled")) {
        event.preventDefault();
        return;
      }
      cancelAutoRedirect();
      event.preventDefault();
      window.location.replace("webui");
    });
    goWebuiBtn.addEventListener("click", (event) => {
      event.preventDefault();
      window.location.replace("webui");
    });
    hardRefreshBtn.addEventListener("click", () => {
      if (pollHandle) {
        clearTimeout(pollHandle);
      }
      cancelAutoRedirect();
      loadState();
    });
    toggleAdvancedBtn.addEventListener("click", () => {
      advancedModeEnabled = !advancedModeEnabled;
      renderAdvancedMode();
      saveUiPrefs();
    });
    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "visible") {
        if (pollHandle) {
          clearTimeout(pollHandle);
        }
        loadState();
      }
    });
    openDirectBtn.addEventListener("click", (event) => {
      if (openDirectBtn.classList.contains("disabled")) {
        event.preventDefault();
      }
    });
    diagBtn.addEventListener("click", runDiagnostics);
    copyReportBtn.addEventListener("click", copyReport);
    loadUiPrefs();
    renderAdvancedMode();
    hydrateRuntimeFromCache();
    loadState();
  </script>
</body>
</html>
