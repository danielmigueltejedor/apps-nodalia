server {
  listen 8099 default_server;

  include /etc/nginx/includes/server_params.conf;
  include /etc/nginx/includes/proxy_params.conf;

  location = /onboarding {
    root /etc/nginx/www;
    add_header Cache-Control "no-store";
    try_files /onboarding.html =404;
  }

  location = /onboarding/ {
    return 302 /onboarding;
  }

  location = /onboarding.json {
    alias /data/tailscale-onboarding.json;
    default_type application/json;
    add_header Cache-Control "no-store";
  }

  location = /nodalia-logo.png {
    root /etc/nginx/www;
    add_header Cache-Control "no-store";
    try_files /nodalia-logo.png =404;
  }

  location = /runtime.json {
    alias /data/tailscale-runtime.json;
    default_type application/json;
    add_header Cache-Control "no-store";
  }

  location = /support-api {
    proxy_connect_timeout 1s;
    proxy_send_timeout 2s;
    # Enabling a support tunnel can take several seconds while cloudflared
    # allocates a public URL. Avoid timing out the CGI response too early.
    proxy_read_timeout 30s;
    add_header Cache-Control "no-store";
    proxy_pass http://127.0.0.1:25910/cgi-bin/support;
  }

  location = /control-api {
    proxy_connect_timeout 1s;
    proxy_send_timeout 2s;
    # Logout/reconnect operations can include fallback steps and daemon restarts.
    # Keep this endpoint responsive without aborting long but valid operations.
    proxy_read_timeout 60s;
    add_header Cache-Control "no-store";
    proxy_pass http://127.0.0.1:25910/cgi-bin/control;
  }

  location = /webui {
    proxy_connect_timeout 2s;
    # Preserve long-lived Web UI connections (SSE/websocket/polling) inside ingress.
    proxy_send_timeout 86400s;
    proxy_read_timeout 86400s;
    proxy_intercept_errors on;
    error_page 500 502 503 504 = /onboarding;
    # Preserve compatibility with old /webui links, but always hit backend root.
    proxy_pass http://backend/;

    # Keep Tailscale's internal top-window redirect behavior.
    sub_filter_once off;
    sub_filter 'document.location.href = url' 'window.top.location.href = url';
    sub_filter '</body>' '<script>(function(){try{if(document.getElementById("nodalia-back-btn"))return;var a=document.createElement("a");a.id="nodalia-back-btn";var p=window.location.pathname||"/";var i=p.indexOf("/webui");var b=i>=0?p.slice(0,i+1):(p.endsWith("/")?p:p.slice(0,p.lastIndexOf("/")+1));a.href=b+"onboarding";a.textContent="Volver al panel Nodalia";a.style.cssText="position:fixed;left:16px;bottom:16px;z-index:2147483647;background:#0b63ce;color:#fff;padding:10px 12px;border-radius:10px;text-decoration:none;font:700 13px/1.1 Segoe UI,Noto Sans,sans-serif;box-shadow:0 8px 22px rgba(0,0,0,.25)";document.body.appendChild(a);}catch(e){}})();</script></body>';
  }

  location = /webui/ {
    return 302 /webui;
  }

  location = /webui-ready {
    proxy_connect_timeout 1s;
    proxy_send_timeout 2s;
    proxy_read_timeout 2s;
    # Probe backend root to avoid false negatives on non-root paths.
    proxy_pass http://backend/;
  }

  location / {
    proxy_connect_timeout 2s;
    # Preserve long-lived Web UI connections (SSE/websocket/polling) inside ingress.
    proxy_send_timeout 86400s;
    proxy_read_timeout 86400s;
    proxy_intercept_errors on;
    error_page 500 502 503 504 = /onboarding;
    proxy_pass http://backend;

    # Keep Tailscale's internal top-window redirect behavior.
    # This matches the stable channel's proven flow.
    sub_filter_once off;
    sub_filter 'document.location.href = url' 'window.top.location.href = url';
    sub_filter '</body>' '<script>(function(){try{if(document.getElementById("nodalia-back-btn"))return;var a=document.createElement("a");a.id="nodalia-back-btn";var p=window.location.pathname||"/";var i=p.indexOf("/webui");var b=i>=0?p.slice(0,i+1):(p.endsWith("/")?p:p.slice(0,p.lastIndexOf("/")+1));a.href=b+"onboarding";a.textContent="Volver al panel Nodalia";a.style.cssText="position:fixed;left:16px;bottom:16px;z-index:2147483647;background:#0b63ce;color:#fff;padding:10px 12px;border-radius:10px;text-decoration:none;font:700 13px/1.1 Segoe UI,Noto Sans,sans-serif;box-shadow:0 8px 22px rgba(0,0,0,.25)";document.body.appendChild(a);}catch(e){}})();</script></body>';
  }
}
