name: Auto-update Tailscale (stable) + Release

on:
  schedule:
    - cron: "15 2 * * *" # Diario 02:15 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Detect addon directory (root or subfolder)
        id: paths
        shell: bash
        run: |
          set -euo pipefail
          if [ -f "Dockerfile" ] && [ -f "config.yaml" ]; then
            echo "dir=." >> "$GITHUB_OUTPUT"
          elif [ -f "tailscale_nodalia/Dockerfile" ] && [ -f "tailscale_nodalia/config.yaml" ]; then
            echo "dir=tailscale_nodalia" >> "$GITHUB_OUTPUT"
          elif [ -f "tailscale/Dockerfile" ] && [ -f "tailscale/config.yaml" ]; then
            echo "dir=tailscale" >> "$GITHUB_OUTPUT"
          else
            echo "No encuentro Dockerfile+config.yaml (ni en root, ni tailscale_nodalia/, ni tailscale/)"
            exit 1
          fi

      # ✅ USAR EL CANAL STABLE REAL DE LINUX (el que siguen Debian/Proxmox si instalas desde pkgs.tailscale.com)
      - name: Get latest stable Tailscale version (pkgs.tailscale.com)
        id: ts
        shell: bash
        run: |
          set -euo pipefail

          JSON=$(curl -fsSL "https://pkgs.tailscale.com/stable/?mode=json")

          # La clave suele ser "Version". Añadimos fallbacks por si cambia el formato.
          LATEST=$(
            echo "$JSON" | jq -r '
              .Version // .version // .Linux // .linux // empty
            '
          )

          if [ -z "$LATEST" ] || [ "$LATEST" = "null" ]; then
            echo "No pude obtener version desde pkgs.tailscale.com/stable/?mode=json"
            echo "Primeros 2000 chars del JSON para depurar:"
            echo "$JSON" | head -c 2000 || true
            echo
            exit 1
          fi

          LATEST="${LATEST#v}"
          echo "latest=${LATEST}" >> "$GITHUB_OUTPUT"
          echo "latest_tag=v${LATEST}" >> "$GITHUB_OUTPUT"

      - name: Read current TAILSCALE_VERSION from Dockerfile
        id: cur
        shell: bash
        run: |
          set -euo pipefail
          DIR="${{ steps.paths.outputs.dir }}"

          if ! grep -qE '^ARG[[:space:]]+TAILSCALE_VERSION=' "${DIR}/Dockerfile"; then
            echo "No existe 'ARG TAILSCALE_VERSION=' en ${DIR}/Dockerfile"
            exit 1
          fi

          # Si tu Dockerfile tiene varios stages con el mismo ARG, normalmente interesa el ÚLTIMO.
          CURRENT=$(grep -E '^ARG[[:space:]]+TAILSCALE_VERSION=' "${DIR}/Dockerfile" \
            | tail -n 1 \
            | sed -E 's/^ARG[[:space:]]+TAILSCALE_VERSION="?([^"]+)"?/\1/' \
            | tr -d '\r')

          CURRENT="${CURRENT#v}"
          echo "current=${CURRENT}" >> "$GITHUB_OUTPUT"

      - name: Check if update needed
        id: check
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ steps.ts.outputs.latest }}" != "${{ steps.cur.outputs.current }}" ]; then
            echo "needs_update=true" >> "$GITHUB_OUTPUT"
          else
            echo "needs_update=false" >> "$GITHUB_OUTPUT"
          fi

      # (Opcional pero útil) Debug de qué está comparando
      - name: Debug versions
        shell: bash
        run: |
          echo "DIR=${{ steps.paths.outputs.dir }}"
          echo "CURRENT=${{ steps.cur.outputs.current }}"
          echo "LATEST=${{ steps.ts.outputs.latest }}"
          echo "NEEDS_UPDATE=${{ steps.check.outputs.needs_update }}"

      - name: Update Dockerfile TAILSCALE_VERSION
        if: ${{ steps.check.outputs.needs_update == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          DIR="${{ steps.paths.outputs.dir }}"
          LATEST="${{ steps.ts.outputs.latest }}"
          sed -i -E "s/^ARG[[:space:]]+TAILSCALE_VERSION=.*/ARG TAILSCALE_VERSION=\"${LATEST}\"/" "${DIR}/Dockerfile"
          echo "Dockerfile actualizado a ${LATEST}"

      - name: Bump addon version (minor, reset patch)
        if: ${{ steps.check.outputs.needs_update == 'true' }}
        id: bump
        shell: bash
        run: |
          set -euo pipefail
          DIR="${{ steps.paths.outputs.dir }}"

          CURRENT_VER=$(grep -E '^version:' "${DIR}/config.yaml" | head -n 1 | awk '{print $2}' | tr -d '"\r')
          if [ -z "$CURRENT_VER" ]; then
            echo "No pude leer version: en ${DIR}/config.yaml"
            exit 1
          fi

          IFS='.' read -r X Y Z <<< "$CURRENT_VER" || true
          if [[ -z "${X:-}" || -z "${Y:-}" || -z "${Z:-}" ]] || \
             ! [[ "$X" =~ ^[0-9]+$ && "$Y" =~ ^[0-9]+$ && "$Z" =~ ^[0-9]+$ ]]; then
            echo "Version no valida en config.yaml: ${CURRENT_VER}"
            exit 1
          fi

          NEW_VER="${X}.$((Y+1)).0"
          sed -i -E "s/^version: .*/version: ${NEW_VER}/" "${DIR}/config.yaml"

          echo "new_ver=${NEW_VER}" >> "$GITHUB_OUTPUT"
          echo "old_ver=${CURRENT_VER}" >> "$GITHUB_OUTPUT"

      - name: Update CHANGELOG.md and prepare release notes
        if: ${{ steps.check.outputs.needs_update == 'true' }}
        id: notes
        shell: bash
        run: |
          set -euo pipefail
          DIR="${{ steps.paths.outputs.dir }}"

          CHANGELOG="${DIR}/CHANGELOG.md"
          NOTES_FILE="${RUNNER_TEMP}/release_notes.md"
          DATE=$(date -u +"%Y-%m-%d")

          CURRENT_TS="${{ steps.cur.outputs.current }}"
          LATEST_TS="${{ steps.ts.outputs.latest }}"
          OLD_ADDON="${{ steps.bump.outputs.old_ver }}"
          NEW_ADDON="${{ steps.bump.outputs.new_ver }}"

          if [ ! -f "$CHANGELOG" ]; then
            {
              echo "# Changelog"
              echo
              echo "All notable changes to this add-on will be documented in this file."
              echo
              echo "The format is based on Keep a Changelog, and this project adheres to Semantic Versioning."
              echo
            } > "$CHANGELOG"
          fi

          ENTRY=$(printf "## %s - %s\n### Changed\n- Bump Tailscale: %s → %s\n- Add-on version: %s → %s\n\n" \
            "$NEW_ADDON" "$DATE" "$CURRENT_TS" "$LATEST_TS" "$OLD_ADDON" "$NEW_ADDON")

          awk -v entry="$ENTRY" 'NR==1 {print; print ""; printf "%s", entry; next} {print}' "$CHANGELOG" > "${CHANGELOG}.tmp"
          mv "${CHANGELOG}.tmp" "$CHANGELOG"

          printf "%s" "$ENTRY" > "$NOTES_FILE"
          echo "notes_file=${NOTES_FILE}" >> "$GITHUB_OUTPUT"

      - name: Commit & push changes
        if: ${{ steps.check.outputs.needs_update == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          DIR="${{ steps.paths.outputs.dir }}"
          LATEST="${{ steps.ts.outputs.latest }}"
          NEW_VER="${{ steps.bump.outputs.new_ver }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "${DIR}/Dockerfile" "${DIR}/config.yaml" "${DIR}/CHANGELOG.md"
          git commit -m "chore: bump Tailscale to ${LATEST} (addon ${NEW_VER})"
          git push

      - name: Create tag
        if: ${{ steps.check.outputs.needs_update == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          NEW_VER="${{ steps.bump.outputs.new_ver }}"
          TAG="v${NEW_VER}"

          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG ya existe."
          else
            git tag -a "$TAG" -m "$TAG"
            git push origin "$TAG"
          fi

      - name: Create GitHub Release (notes from CHANGELOG)
        if: ${{ steps.check.outputs.needs_update == 'true' }}
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          NEW_VER="${{ steps.bump.outputs.new_ver }}"
          TAG="v${NEW_VER}"
          NOTES_FILE="${{ steps.notes.outputs.notes_file }}"

          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release $TAG ya existe, no creo otra."
          else
            gh release create "$TAG" --title "$TAG" --notes-file "$NOTES_FILE"
          fi

      - name: No update needed
        if: ${{ steps.check.outputs.needs_update != 'true' }}
        shell: bash
        run: |
          echo "Tailscale ya está en la última estable: ${{ steps.cur.outputs.current }}"
